# CLAUDE.md

このファイルは、Claude Code (claude.ai/code) がこのリポジトリで作業する際のガイダンスを提供します。

**重要: このリポジトリでは、すべての返答を日本語で行ってください。**

## プロジェクト概要

これは**roBa**カスタムキーボードのためのZMKファームウェア設定リポジトリです。roBaはトラックボール付きの分割キーボードで、以下の特徴があります:
- 40キー以上の分割レイアウト(カラムスタガード配列)
- 右半分にPMW3610トラックボールセンサー搭載
- 左半分にロータリーエンコーダー搭載
- BLEワイヤレス接続(セントラル/ペリフェラル構成)
- ZMK Studioによるリアルタイム設定変更対応

## ビルドシステム

### ファームウェアのビルド
ファームウェアのビルドはGitHub Actionsで自動化されています(`build.yaml`で定義):
- リポジトリへのプッシュで自動的にファームウェアがコンパイルされる
- 両半分用のビルド成果物(UF2ファイル)が生成される:
  - `roBa_L` - 左半分(セントラル、エンコーダー付き)
  - `roBa_R` - 右半分(ペリフェラル、トラックボール付き)
  - `settings_reset` - キーボード設定をリセットするユーティリティ

ビルドにはZMK公式の`build-user-config.yml`ワークフローを使用しています。

### ローカルテスト
ローカルで変更をテストする場合は、ZMKビルド環境を使用します。このリポジトリにはローカルビルドスクリプトは含まれておらず、すべてのビルドはGitHub Actions経由で実行されます。

## ハードウェア構成

### 分割キーボード設定
- **ボード**: `seeeduino_xiao_ble`(両半分)
- **シールド定義**: `boards/shields/roBa/`に配置
- **マトリックス**: 4行×11列(`roBa.dtsi`で定義)
- **ダイオード方向**: col2row

### 左半分 (roBa_L)
- **オーバーレイ**: `roBa_L.overlay`
- **設定**: `roBa_L.conf`
- **機能**:
  - セントラルBLE役割(ペリフェラルを制御)
  - ロータリーエンコーダー(EC11) GPIOピンD5/D0
  - 6列のGPIO (D10, D9, D8, D7, P0.10, P0.09)
  - バッテリーレベル報告有効

### 右半分 (roBa_R)
- **オーバーレイ**: `roBa_R.overlay`
- **設定**: `roBa_R.conf`
- **機能**:
  - ペリフェラルBLE役割
  - PMW3610トラックボールセンサー(SPI経由: P0.05 SCK、P0.04 MOSI/MISO、P0.09 CS、P0.02 IRQ)
  - 5列のGPIO (D10, D9, D8, D7, P0.10)
  - ZMK Studioによるライブ設定有効
  - レイヤー3での特殊スクロール動作(Y軸反転スクロールマッピング)

### トラックボール設定 (roBa_R.conf)
主要なPMW3610設定:
- CPI: 400 (カーソル速度)
- オリエンテーション: 0° (動きが逆の場合は180°に変更)
- スクロールティック: 16 (スクロール感度調整用)
- ポーリングレート: 125Hz
- オートマウスタイムアウト: 700ms (自動的にレイヤー4に切り替わる)
- スマートアルゴリズム有効(トラッキング精度向上)

**注**: コメントにCOROPITトラックボールモジュールの設定が記載されています(Booth商品 #6830658)

## キーマップ構造

### ファイル位置
- **メインキーマップ**: `config/roBa.keymap`

### レイヤー構成
キーマップは7つのレイヤー(0-6)を定義しています:

1. **レイヤー0 (default_layer)**: ベースの英数字レイアウト
   - ホームロウモディファイア(A/;の位置にシフト)
   - 他のレイヤーにアクセスするためのレイヤータップ動作
   - エンコーダー: Page Up/Down

2. **レイヤー1 (NUM)**: 数字と記号
   - ホームポジションに数字1-9、0
   - シフト+数字 = 記号(!@#$%など)
   - 括弧、カッコ、数学演算子

3. **レイヤー2 (MOUSE)**: マウスとメディアコントロール
   - マウスボタン(MB1、MB2、MB3)
   - 矢印キーとナビゲーション
   - 音量コントロール、デスクトップ切り替え(macOS)

4. **レイヤー3 (ARROW)**: 矢印キーとナビゲーション
   - Home/End付き方向矢印
   - タブ切り替え(Ctrl+Tab)
   - macOSウィンドウ管理ショートカット
   - エンコーダー: Ctrl+Page Up/Down(ブラウザタブ切り替え)

5. **レイヤー4 (SCROLL)**: トラックボールスクロールモード
   - オートマウスレイヤー(トラックボール移動時に自動起動)
   - すべてのキーが透過(パススルー)
   - エンコーダー: `&rot_msc`によるスクロールアップ/ダウン

6. **レイヤー5 (FUNCTION)**: ファンクションキー
   - F1-F12にアクセス可能

7. **レイヤー6**: システムとBluetooth
   - Bluetoothプロファイル選択(BT_SEL 0-4)
   - Bluetoothクリア(BT_CLR、BT_CLR_ALL)
   - ブートローダーアクセス

### カスタムビヘイビア

**`lt_to_layer_0`**: カスタムホールドタップ動作
- ホールド: 一時的なレイヤー起動
- タップ: レイヤー0に戻る+キーコード送信
- タッピングターム: 200ms
- レイヤーナビゲーションに広く使用され、ベースレイヤーへの確実な復帰を保証

**`rot_msc`**: ロータリーエンコーダースクロール動作
- エンコーダー回転をマウススクロールイベントにマッピング
- レイヤー4(SCROLL)で使用

**`to_layer_0` マクロ**: 1パラメータマクロ
- レイヤー0に切り替えて1つのアクションでキーコードを送信

### コンボ
特定のアクションをトリガーするキーの組み合わせ:
- キー11+12: Tab
- キー12+13: Shift+Tab
- キー11+10: レイヤー0に戻る + 無変換
- キー20+21: ダブルクォート
- キー24+25: イコール記号

## 依存関係

### West Manifest (config/west.yml)
プロジェクトは依存関係管理にZephyrのWestツールを使用:
- **zmk**: メインZMKファームウェア(zmkfirmware/zmk@mainから)
- **zmk-pmw3610-driver**: トラックボールドライバー(kumamuk-git/zmk-pmw3610-driver@mainから)

## よくある修正タスク

### キーマップの調整
`config/roBa.keymap`を編集:
- レイヤー定義内のキーバインディングを変更
- `combos`セクションでコンボを追加/削除
- ビヘイビア定義でレイヤータップのタイミングを調整
- `sensor-bindings`でエンコーダーバインディングを変更

### トラックボール動作の調整
`boards/shields/roBa/roBa_R.conf`を編集:
- **CPI調整**: `CONFIG_PMW3610_CPI=400`を変更(高い値=速いカーソル)
- **スクロール速度**: `CONFIG_PMW3610_SCROLL_TICK=16`を調整(低い値=速いスクロール)
- **オートマウスタイムアウト**: `CONFIG_PMW3610_AUTOMOUSE_TIMEOUT_MS=700`を変更
- **オリエンテーション**: `CONFIG_PMW3610_ORIENTATION_0=y`と`CONFIG_PMW3610_ORIENTATION_180=y`を切り替え

`config/roBa.keymap`を編集:
- **オートマウスレイヤー**: `&trackball`ブロック内の`automouse-layer = <4>;`
- **スクロールレイヤー**: `&trackball`ブロック内の`scroll-layers = <5>;`

### 物理レイアウトの変更
`boards/shields/roBa/roBa.dtsi`を編集:
- キーマップビジュアライザー用に`roba_physical_layout`のキー位置を変更
- 電気的マトリックス構成を変更する場合はマトリックストランスフォームを調整

## 重要な注意事項

### 日本語入力メソッドキー
キーマップには日本語IMEキーが含まれています:
- `INT_HENKAN`: 変換キー
- `INT_MUHENKAN`: 無変換キー

これらはmacOS/Windowsでの日本語入力切り替えに不可欠です。

### macOS固有のショートカット
レイヤー2/3の多くのバインディングはmacOSモディファイアを使用:
- `LG()` / `RG()`: 左/右GUI(Commandキー)
- `LA()`: 左Alt(Optionキー)
- デスクトップ切り替え、Spotlight、アプリ切り替えショートカット

### トラックボール入力処理
右半分のオーバーレイ(`roBa_R.overlay`)は特殊なスクロール動作を定義:
```c
scroll_on_layer3 {
    layers = <3>;
    input-processors = <&zip_xy_scaler 1 10 &zip_xy_to_scroll_mapper &zip_scroll_transform (INPUT_TRANSFORM_Y_INVERT)>;
}
```
これによりレイヤー3でY軸反転トラックボールスクロールが有効になります。

## キーマップの可視化

`keymap-drawer/`ディレクトリには可視化ファイルが含まれています:
- `roBa.yaml`: Keymap drawer設定
- `roBa.svg`: キーマップの視覚的表現

これらは`draw.yml` GitHubワークフローによって自動生成されている可能性があります。
